diff -urpN linux-source-2.6.18.orig/fs/dnotify.c linux-source-2.6.18/fs/dnotify.c
--- linux-source-2.6.18.orig/fs/dnotify.c	2008-04-12 00:25:30.000000000 -0600
+++ linux-source-2.6.18/fs/dnotify.c	2008-04-23 21:32:55.000000000 -0600
@@ -20,7 +20,9 @@
 #include <linux/init.h>
 #include <linux/spinlock.h>
 #include <linux/slab.h>
+#ifndef __GENKSYMS__
 #include <linux/file.h>
+#endif
 
 int dir_notify_enable __read_mostly = 1;
 
@@ -93,9 +95,11 @@ int fcntl_dirnotify(int fd, struct file 
 		prev = &odn->dn_next;
 	}
 
+#ifndef __GENKSYMS__
 	/* we'd lost the race with close(), sod off silently */
 	if (fcheck(fd) != filp)
 		goto out_free;
+#endif
 
 	error = f_setown(filp, current->pid, 0);
 	if (error)
