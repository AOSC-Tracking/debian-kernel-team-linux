From f627a741d24f12955fa2d9f8831c3b12860635bd Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:13:58 +0100
Subject: [PATCH 06/44] [CVE-2009-0029] Make sys_syslog a conditional system call

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit f627a741d24f12955fa2d9f8831c3b12860635bd upstream.

Remove the -ENOSYS implementation for !CONFIG_PRINTK and use
the cond_syscall infrastructure instead.

Acked-by: Kyle McMartin <kyle@redhat.com>
Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.18 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.18.orig/kernel/printk.c linux-source-2.6.18/kernel/printk.c
--- linux-source-2.6.18.orig/kernel/printk.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/kernel/printk.c	2009-01-25 20:16:55.000000000 -0700
@@ -628,11 +628,6 @@ EXPORT_SYMBOL(vprintk);
 
 #else
 
-asmlinkage long sys_syslog(int type, char __user *buf, int len)
-{
-	return 0;
-}
-
 int do_syslog(int type, char __user *buf, int len)
 {
 	return 0;
diff -urpN linux-source-2.6.18.orig/kernel/sys_ni.c linux-source-2.6.18/kernel/sys_ni.c
--- linux-source-2.6.18.orig/kernel/sys_ni.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/kernel/sys_ni.c	2009-01-25 20:12:07.000000000 -0700
@@ -111,6 +111,7 @@ cond_syscall(sys_vm86old);
 cond_syscall(sys_vm86);
 cond_syscall(compat_sys_ipc);
 cond_syscall(compat_sys_sysctl);
+cond_syscall(sys_syslog);
 
 /* arch-specific weak syscall entries */
 cond_syscall(sys_pciconfig_read);
