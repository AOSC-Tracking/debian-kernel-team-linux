commit d35c7b0e54a596c5a8134d75999b7f391a9c6550
Author: Ulrich Drepper <drepper@redhat.com>
Date:   Sat May 3 15:10:37 2008 -0400

    unified (weak) sys_pipe implementation
    
    This replaces the duplicated arch-specific versions of "sys_pipe()" with
    one unified implementation.  This removes almost 250 lines of duplicated
    code.
    
    It's marked __weak, so that *if* an architecture wants to override the
    default implementation it can do so by simply having its own replacement
    version, since many architectures use alternate calling conventions for
    the 'pipe()' system call for legacy reasons (ie traditional UNIX
    implementations often return the two file descriptors in registers)
    
    I still haven't changed the cris version even though Linus says the BKL
    isn't needed.  The arch maintainer can easily do it if there are really
    no obstacles.
    
    Signed-off-by: Ulrich Drepper <drepper@redhat.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

Backported to Debian's 2.6.18 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.18.orig/arch/arm/kernel/sys_arm.c linux-source-2.6.18/arch/arm/kernel/sys_arm.c
--- linux-source-2.6.18.orig/arch/arm/kernel/sys_arm.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/arm/kernel/sys_arm.c	2009-01-25 20:04:55.000000000 -0700
@@ -34,23 +34,6 @@ extern unsigned long do_mremap(unsigned 
 			       unsigned long new_len, unsigned long flags,
 			       unsigned long new_addr);
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-asmlinkage int sys_pipe(unsigned long __user *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 /* common code for old and new mmaps */
 inline long do_mmap2(
 	unsigned long addr, unsigned long len,
diff -urpN linux-source-2.6.18.orig/arch/frv/kernel/sys_frv.c linux-source-2.6.18/arch/frv/kernel/sys_frv.c
--- linux-source-2.6.18.orig/arch/frv/kernel/sys_frv.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/frv/kernel/sys_frv.c	2009-01-25 20:05:12.000000000 -0700
@@ -28,23 +28,6 @@
 #include <asm/uaccess.h>
 #include <asm/ipc.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-asmlinkage long sys_pipe(unsigned long __user * fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 asmlinkage long sys_mmap2(unsigned long addr, unsigned long len,
 			  unsigned long prot, unsigned long flags,
 			  unsigned long fd, unsigned long pgoff)
diff -urpN linux-source-2.6.18.orig/arch/h8300/kernel/sys_h8300.c linux-source-2.6.18/arch/h8300/kernel/sys_h8300.c
--- linux-source-2.6.18.orig/arch/h8300/kernel/sys_h8300.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/h8300/kernel/sys_h8300.c	2009-01-25 20:05:12.000000000 -0700
@@ -26,23 +26,6 @@
 #include <asm/traps.h>
 #include <asm/ipc.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-asmlinkage int sys_pipe(unsigned long * fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 /* common code for old and new mmaps */
 static inline long do_mmap2(
 	unsigned long addr, unsigned long len,
diff -urpN linux-source-2.6.18.orig/arch/i386/kernel/sys_i386.c linux-source-2.6.18/arch/i386/kernel/sys_i386.c
--- linux-source-2.6.18.orig/arch/i386/kernel/sys_i386.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/i386/kernel/sys_i386.c	2009-01-25 20:06:26.000000000 -0700
@@ -23,23 +23,6 @@
 #include <asm/uaccess.h>
 #include <asm/ipc.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way Unix traditionally does this, though.
- */
-asmlinkage int sys_pipe(unsigned long __user * fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 asmlinkage long sys_mmap2(unsigned long addr, unsigned long len,
 			  unsigned long prot, unsigned long flags,
 			  unsigned long fd, unsigned long pgoff)
diff -urpN linux-source-2.6.18.orig/arch/m68k/kernel/sys_m68k.c linux-source-2.6.18/arch/m68k/kernel/sys_m68k.c
--- linux-source-2.6.18.orig/arch/m68k/kernel/sys_m68k.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/m68k/kernel/sys_m68k.c	2009-01-25 20:05:12.000000000 -0700
@@ -28,23 +28,6 @@
 #include <asm/ipc.h>
 #include <asm/page.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-asmlinkage int sys_pipe(unsigned long __user * fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 /* common code for old and new mmaps */
 static inline long do_mmap2(
 	unsigned long addr, unsigned long len,
diff -urpN linux-source-2.6.18.orig/arch/m68knommu/kernel/sys_m68k.c linux-source-2.6.18/arch/m68knommu/kernel/sys_m68k.c
--- linux-source-2.6.18.orig/arch/m68knommu/kernel/sys_m68k.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/m68knommu/kernel/sys_m68k.c	2009-01-25 20:05:12.000000000 -0700
@@ -27,23 +27,6 @@
 #include <asm/ipc.h>
 #include <asm/cacheflush.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-asmlinkage int sys_pipe(unsigned long * fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 /* common code for old and new mmaps */
 static inline long do_mmap2(
 	unsigned long addr, unsigned long len,
diff -urpN linux-source-2.6.18.orig/arch/parisc/kernel/sys_parisc.c linux-source-2.6.18/arch/parisc/kernel/sys_parisc.c
--- linux-source-2.6.18.orig/arch/parisc/kernel/sys_parisc.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/parisc/kernel/sys_parisc.c	2009-01-25 20:05:12.000000000 -0700
@@ -32,19 +32,6 @@
 #include <linux/smp_lock.h>
 #include <linux/syscalls.h>
 
-int sys_pipe(int __user *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 static unsigned long get_unshared_area(unsigned long addr, unsigned long len)
 {
 	struct vm_area_struct *vma;
diff -urpN linux-source-2.6.18.orig/arch/powerpc/kernel/syscalls.c linux-source-2.6.18/arch/powerpc/kernel/syscalls.c
--- linux-source-2.6.18.orig/arch/powerpc/kernel/syscalls.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/powerpc/kernel/syscalls.c	2009-01-25 20:05:12.000000000 -0700
@@ -138,23 +138,6 @@ int sys_ipc(uint call, int first, unsign
 	return ret;
 }
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-int sys_pipe(int __user *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 static inline unsigned long do_mmap2(unsigned long addr, size_t len,
 			unsigned long prot, unsigned long flags,
 			unsigned long fd, unsigned long off, int shift)
diff -urpN linux-source-2.6.18.orig/arch/s390/kernel/sys_s390.c linux-source-2.6.18/arch/s390/kernel/sys_s390.c
--- linux-source-2.6.18.orig/arch/s390/kernel/sys_s390.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/s390/kernel/sys_s390.c	2009-01-25 20:05:12.000000000 -0700
@@ -31,23 +31,6 @@
 #include <asm/uaccess.h>
 #include <asm/ipc.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way Unix traditionally does this, though.
- */
-asmlinkage long sys_pipe(unsigned long __user *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 /* common code for old and new mmaps */
 static inline long do_mmap2(
 	unsigned long addr, unsigned long len,
diff -urpN linux-source-2.6.18.orig/arch/um/kernel/syscall.c linux-source-2.6.18/arch/um/kernel/syscall.c
--- linux-source-2.6.18.orig/arch/um/kernel/syscall.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/um/kernel/syscall.c	2009-01-25 20:07:34.000000000 -0700
@@ -86,23 +86,6 @@ long old_mmap(unsigned long addr, unsign
  out:
 	return err;
 }
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-long sys_pipe(unsigned long __user * fildes)
-{
-        int fd[2];
-        long error;
-
-        error = do_pipe(fd);
-        if (!error) {
-		if (copy_to_user(fildes, fd, sizeof(fd)))
-                        error = -EFAULT;
-        }
-        return error;
-}
-
 
 long sys_uname(struct old_utsname __user * name)
 {
diff -urpN linux-source-2.6.18.orig/arch/v850/kernel/syscalls.c linux-source-2.6.18/arch/v850/kernel/syscalls.c
--- linux-source-2.6.18.orig/arch/v850/kernel/syscalls.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/v850/kernel/syscalls.c	2009-01-25 20:05:19.000000000 -0700
@@ -134,23 +134,6 @@ sys_ipc (uint call, int first, int secon
 	return ret;
 }
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way unix traditionally does this, though.
- */
-int sys_pipe (int *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe (fd);
-	if (!error) {
-		if (copy_to_user (fildes, fd, 2*sizeof (int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 static inline unsigned long
 do_mmap2 (unsigned long addr, size_t len,
 	 unsigned long prot, unsigned long flags,
diff -urpN linux-source-2.6.18.orig/arch/x86_64/kernel/sys_x86_64.c linux-source-2.6.18/arch/x86_64/kernel/sys_x86_64.c
--- linux-source-2.6.18.orig/arch/x86_64/kernel/sys_x86_64.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/x86_64/kernel/sys_x86_64.c	2009-01-25 20:06:48.000000000 -0700
@@ -20,23 +20,6 @@
 #include <asm/uaccess.h>
 #include <asm/ia32.h>
 
-/*
- * sys_pipe() is the normal C calling standard for creating
- * a pipe. It's not the way Unix traditionally does this, though.
- */
-asmlinkage long sys_pipe(int __user *fildes)
-{
-	int fd[2];
-	int error;
-
-	error = do_pipe(fd);
-	if (!error) {
-		if (copy_to_user(fildes, fd, 2*sizeof(int)))
-			error = -EFAULT;
-	}
-	return error;
-}
-
 asmlinkage long sys_mmap(unsigned long addr, unsigned long len, unsigned long prot, unsigned long flags,
 	unsigned long fd, unsigned long off)
 {
diff -urpN linux-source-2.6.18.orig/fs/pipe.c linux-source-2.6.18/fs/pipe.c
--- linux-source-2.6.18.orig/fs/pipe.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/fs/pipe.c	2009-01-25 20:06:48.000000000 -0700
@@ -974,6 +974,23 @@ no_files:
 }
 
 /*
+ * sys_pipe() is the normal C calling standard for creating
+ * a pipe. It's not the way Unix traditionally does this, though.
+ */
+asmlinkage long __weak sys_pipe(int __user *fildes)
+{
+	int fd[2];
+	int error;
+
+	error = do_pipe(fd);
+	if (!error) {
+		if (copy_to_user(fildes, fd, sizeof(fd)))
+			error = -EFAULT;
+	}
+	return error;
+}
+
+/*
  * pipefs should _never_ be mounted by userland - too much of security hassle,
  * no real gain from having the whole whorehouse mounted. So we don't need
  * any operations on the root directory. However, we need a non-trivial
diff -urpN linux-source-2.6.18.orig/include/asm-powerpc/syscalls.h linux-source-2.6.18/include/asm-powerpc/syscalls.h
--- linux-source-2.6.18.orig/include/asm-powerpc/syscalls.h	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/include/asm-powerpc/syscalls.h	2009-01-25 20:06:48.000000000 -0700
@@ -30,7 +30,7 @@ asmlinkage int sys_fork(unsigned long p1
 asmlinkage int sys_vfork(unsigned long p1, unsigned long p2,
 		unsigned long p3, unsigned long p4, unsigned long p5,
 		unsigned long p6, struct pt_regs *regs);
-asmlinkage int sys_pipe(int __user *fildes);
+asmlinkage long sys_pipe(int __user *fildes);
 asmlinkage long sys_rt_sigaction(int sig,
 		const struct sigaction __user *act,
 		struct sigaction __user *oact, size_t sigsetsize);
