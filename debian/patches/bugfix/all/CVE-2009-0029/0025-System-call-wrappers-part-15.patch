From a26eab2400f0477bfac0255600552394855016f7 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:14:17 +0100
Subject: [PATCH 25/44] [CVE-2009-0029] System call wrappers part 15

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit a26eab2400f0477bfac0255600552394855016f7 upstream.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.24 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.24.orig/fs/fcntl.c linux-source-2.6.24/fs/fcntl.c
--- linux-source-2.6.24.orig/fs/fcntl.c	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/fs/fcntl.c	2009-01-21 01:11:17.000000000 -0700
@@ -137,7 +137,7 @@ static int dupfd(struct file *file, unsi
 	return fd;
 }
 
-asmlinkage long sys_dup2(unsigned int oldfd, unsigned int newfd)
+SYSCALL_DEFINE2(dup2, unsigned int, oldfd, unsigned int, newfd)
 {
 	int err = -EBADF;
 	struct file * file, *tofree;
@@ -193,7 +193,7 @@ out_fput:
 	goto out;
 }
 
-asmlinkage long sys_dup(unsigned int fildes)
+SYSCALL_DEFINE1(dup, unsigned int, fildes)
 {
 	int ret = -EBADF;
 	struct file * file = fget(fildes);
@@ -387,7 +387,7 @@ static long do_fcntl(int fd, unsigned in
 	return err;
 }
 
-asmlinkage long sys_fcntl(unsigned int fd, unsigned int cmd, unsigned long arg)
+SYSCALL_DEFINE3(fcntl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)
 {	
 	struct file *filp;
 	long err = -EBADF;
@@ -410,7 +410,8 @@ out:
 }
 
 #if BITS_PER_LONG == 32
-asmlinkage long sys_fcntl64(unsigned int fd, unsigned int cmd, unsigned long arg)
+SYSCALL_DEFINE3(fcntl64, unsigned int, fd, unsigned int, cmd,
+		unsigned long, arg)
 {	
 	struct file * filp;
 	long err;
diff -urpN linux-source-2.6.24.orig/fs/ioctl.c linux-source-2.6.24/fs/ioctl.c
--- linux-source-2.6.24.orig/fs/ioctl.c	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/fs/ioctl.c	2009-01-21 01:11:17.000000000 -0700
@@ -154,7 +154,7 @@ int vfs_ioctl(struct file *filp, unsigne
 	return error;
 }
 
-asmlinkage long sys_ioctl(unsigned int fd, unsigned int cmd, unsigned long arg)
+SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)
 {
 	struct file * filp;
 	int error = -EBADF;
diff -urpN linux-source-2.6.24.orig/fs/namei.c linux-source-2.6.24/fs/namei.c
--- linux-source-2.6.24.orig/fs/namei.c	2009-01-21 01:10:50.000000000 -0700
+++ linux-source-2.6.24/fs/namei.c	2009-01-21 01:11:17.000000000 -0700
@@ -2681,7 +2681,7 @@ asmlinkage long sys_renameat(int olddfd,
 	return error;
 }
 
-asmlinkage long sys_rename(const char __user *oldname, const char __user *newname)
+SYSCALL_DEFINE2(rename, const char __user *, oldname, const char __user *, newname)
 {
 	return sys_renameat(AT_FDCWD, oldname, AT_FDCWD, newname);
 }
diff -urpN linux-source-2.6.24.orig/fs/open.c linux-source-2.6.24/fs/open.c
--- linux-source-2.6.24.orig/fs/open.c	2009-01-21 01:10:50.000000000 -0700
+++ linux-source-2.6.24/fs/open.c	2009-01-21 01:11:17.000000000 -0700
@@ -573,7 +573,7 @@ out:
 	return error;
 }
 
-asmlinkage long sys_fchmod(unsigned int fd, mode_t mode)
+SYSCALL_DEFINE2(fchmod, unsigned int, fd, mode_t, mode)
 {
 	struct inode * inode;
 	struct dentry * dentry;
@@ -645,7 +645,7 @@ out:
 	return error;
 }
 
-asmlinkage long sys_chmod(const char __user *filename, mode_t mode)
+SYSCALL_DEFINE2(chmod, const char __user *, filename, mode_t, mode)
 {
 	return sys_fchmodat(AT_FDCWD, filename, mode);
 }
