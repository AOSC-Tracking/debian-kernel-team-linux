From e55380edf68796d75bf41391a781c68ee678587d Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:13:55 +0100
Subject: [PATCH 03/44] [CVE-2009-0029] Rename old_readdir to sys_old_readdir

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit e55380edf68796d75bf41391a781c68ee678587d upstream.

This way it matches the generic system call name convention.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.18 by dann frazier <dannf@debian.org>
(mn10300 and sh arch-specific changes ignored)

diff -urpN linux-source-2.6.18.orig/arch/arm/kernel/calls.S linux-source-2.6.18/arch/arm/kernel/calls.S
--- linux-source-2.6.18.orig/arch/arm/kernel/calls.S	2008-12-25 14:04:13.000000000 -0700
+++ linux-source-2.6.18/arch/arm/kernel/calls.S	2009-01-25 19:51:53.000000000 -0700
@@ -98,7 +98,7 @@
 		CALL(sys_uselib)
 		CALL(sys_swapon)
 		CALL(sys_reboot)
-		CALL(OBSOLETE(old_readdir))	/* used by libc4 */
+		CALL(OBSOLETE(sys_old_readdir))	/* used by libc4 */
 /* 90 */	CALL(OBSOLETE(old_mmap))	/* used by libc4 */
 		CALL(sys_munmap)
 		CALL(sys_truncate)
diff -urpN linux-source-2.6.18.orig/arch/cris/arch-v10/kernel/entry.S linux-source-2.6.18/arch/cris/arch-v10/kernel/entry.S
--- linux-source-2.6.18.orig/arch/cris/arch-v10/kernel/entry.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/cris/arch-v10/kernel/entry.S	2009-01-25 19:51:53.000000000 -0700
@@ -935,7 +935,7 @@ sys_call_table:	
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.18.orig/arch/cris/arch-v32/kernel/entry.S linux-source-2.6.18/arch/cris/arch-v32/kernel/entry.S
--- linux-source-2.6.18.orig/arch/cris/arch-v32/kernel/entry.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/cris/arch-v32/kernel/entry.S	2009-01-25 19:51:53.000000000 -0700
@@ -609,7 +609,7 @@ sys_call_table:
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.18.orig/arch/h8300/kernel/syscalls.S linux-source-2.6.18/arch/h8300/kernel/syscalls.S
--- linux-source-2.6.18.orig/arch/h8300/kernel/syscalls.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/h8300/kernel/syscalls.S	2009-01-25 19:51:53.000000000 -0700
@@ -103,7 +103,7 @@ SYMBOL_NAME_LABEL(sys_call_table)	
 	.long SYMBOL_NAME(sys_uselib)
 	.long SYMBOL_NAME(sys_swapon)
 	.long SYMBOL_NAME(sys_reboot)
-	.long SYMBOL_NAME(old_readdir)
+	.long SYMBOL_NAME(sys_old_readdir)
 	.long SYMBOL_NAME(old_mmap)		/* 90 */
 	.long SYMBOL_NAME(sys_munmap)
 	.long SYMBOL_NAME(sys_truncate)
diff -urpN linux-source-2.6.18.orig/arch/m68k/kernel/entry.S linux-source-2.6.18/arch/m68k/kernel/entry.S
--- linux-source-2.6.18.orig/arch/m68k/kernel/entry.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/m68k/kernel/entry.S	2009-01-25 19:51:53.000000000 -0700
@@ -513,7 +513,7 @@ sys_call_table:
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.18.orig/arch/m68knommu/kernel/syscalltable.S linux-source-2.6.18/arch/m68knommu/kernel/syscalltable.S
--- linux-source-2.6.18.orig/arch/m68knommu/kernel/syscalltable.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/m68knommu/kernel/syscalltable.S	2009-01-25 19:51:53.000000000 -0700
@@ -107,7 +107,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_ni_syscall	/* sys_swapon */
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.18.orig/arch/mips/kernel/scall32-o32.S linux-source-2.6.18/arch/mips/kernel/scall32-o32.S
--- linux-source-2.6.18.orig/arch/mips/kernel/scall32-o32.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/mips/kernel/scall32-o32.S	2009-01-25 19:51:53.000000000 -0700
@@ -431,7 +431,7 @@ einval:	li	v0, -EINVAL
 	sys	sys_uselib		1
 	sys	sys_swapon		2
 	sys	sys_reboot		3
-	sys	old_readdir		3
+	sys	sys_old_readdir		3
 	sys	old_mmap		6	/* 4090 */
 	sys	sys_munmap		2
 	sys	sys_truncate		2
diff -urpN linux-source-2.6.18.orig/arch/sparc/kernel/systbls.S linux-source-2.6.18/arch/sparc/kernel/systbls.S
--- linux-source-2.6.18.orig/arch/sparc/kernel/systbls.S	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/arch/sparc/kernel/systbls.S	2009-01-25 19:51:53.000000000 -0700
@@ -57,7 +57,7 @@ sys_call_table:
 /*185*/	.long sys_setpgid, sys_fremovexattr, sys_tkill, sys_exit_group, sys_newuname
 /*190*/	.long sys_init_module, sys_personality, sparc_remap_file_pages, sys_epoll_create, sys_epoll_ctl
 /*195*/	.long sys_epoll_wait, sys_ioprio_set, sys_getppid, sparc_sigaction, sys_sgetmask
-/*200*/	.long sys_ssetmask, sys_sigsuspend, sys_newlstat, sys_uselib, old_readdir
+/*200*/	.long sys_ssetmask, sys_sigsuspend, sys_newlstat, sys_uselib, sys_old_readdir
 /*205*/	.long sys_readahead, sys_socketcall, sys_syslog, sys_lookup_dcookie, sys_fadvise64
 /*210*/	.long sys_fadvise64_64, sys_tgkill, sys_waitpid, sys_swapoff, sys_sysinfo
 /*215*/	.long sys_ipc, sys_sigreturn, sys_clone, sys_ioprio_get, sys_adjtimex
diff -urpN linux-source-2.6.18.orig/fs/readdir.c linux-source-2.6.18/fs/readdir.c
--- linux-source-2.6.18.orig/fs/readdir.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/fs/readdir.c	2009-01-25 19:54:02.000000000 -0700
@@ -94,7 +94,7 @@ efault:
 	return -EFAULT;
 }
 
-asmlinkage long old_readdir(unsigned int fd, struct old_linux_dirent __user * dirent, unsigned int count)
+asmlinkage long sys_old_readdir(unsigned int fd, struct old_linux_dirent __user * dirent, unsigned int count)
 {
 	int error;
 	struct file * file;
diff -urpN linux-source-2.6.18.orig/include/asm-powerpc/systbl.h linux-source-2.6.18/include/asm-powerpc/systbl.h
--- linux-source-2.6.18.orig/include/asm-powerpc/systbl.h	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/include/asm-powerpc/systbl.h	2009-01-25 19:54:02.000000000 -0700
@@ -92,7 +92,7 @@ COMPAT_SYS_SPU(readlink)
 SYSCALL(uselib)
 SYSCALL(swapon)
 SYSCALL(reboot)
-SYSX(sys_ni_syscall,old32_readdir,old_readdir)
+SYSX(sys_ni_syscall,old32_readdir,sys_old_readdir)
 SYSCALL_SPU(mmap)
 SYSCALL_SPU(munmap)
 SYSCALL_SPU(truncate)
diff -urpN linux-source-2.6.18.orig/include/linux/syscalls.h linux-source-2.6.18/include/linux/syscalls.h
--- linux-source-2.6.18.orig/include/linux/syscalls.h	2009-01-25 19:39:05.000000000 -0700
+++ linux-source-2.6.18/include/linux/syscalls.h	2009-01-25 19:59:00.000000000 -0700
@@ -53,6 +53,7 @@ struct mq_attr;
 struct compat_stat;
 struct compat_timeval;
 struct robust_list_head;
+struct old_linux_dirent;
 
 #include <linux/types.h>
 #include <linux/aio_abi.h>
@@ -583,5 +584,6 @@ asmlinkage long sys_get_robust_list(int 
 				    size_t __user *len_ptr);
 asmlinkage long sys_set_robust_list(struct robust_list_head __user *head,
 				    size_t len);
+asmlinkage long sys_old_readdir(unsigned int, struct old_linux_dirent __user *, unsigned int);
 
 #endif
diff -urpN a/arch/i386/kernel/syscall_table.S b/arch/i386/kernel/syscall_table.S
--- a/arch/i386/kernel/syscall_table.S	2009-01-29 00:16:31.000000000 -0700
+++ b/arch/i386/kernel/syscall_table.S	2009-01-29 00:17:29.000000000 -0700
@@ -88,7 +88,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
