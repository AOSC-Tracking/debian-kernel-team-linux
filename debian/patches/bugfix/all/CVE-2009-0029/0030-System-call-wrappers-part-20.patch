From 3cdad42884bbd95d5aa01297e8236ea1bad70053 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:14:22 +0100
Subject: [PATCH 30/44] [CVE-2009-0029] System call wrappers part 20

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit 3cdad42884bbd95d5aa01297e8236ea1bad70053 upstream.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Adjusted to apply to Debian's 2.6.18 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.18.orig/fs/dcache.c linux-source-2.6.18/fs/dcache.c
--- linux-source-2.6.18.orig/fs/dcache.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/fs/dcache.c	2009-01-25 23:09:50.000000000 -0700
@@ -1508,7 +1508,7 @@ char * d_path(struct dentry *dentry, str
  *		return NULL;
  *	}
  */
-asmlinkage long sys_getcwd(char __user *buf, unsigned long size)
+SYSCALL_DEFINE2(getcwd, char __user *, buf, unsigned long, size)
 {
 	int error;
 	struct vfsmount *pwdmnt, *rootmnt;
diff -urpN linux-source-2.6.18.orig/fs/namei.c linux-source-2.6.18/fs/namei.c
--- linux-source-2.6.18.orig/fs/namei.c	2009-01-25 23:03:21.000000000 -0700
+++ linux-source-2.6.18/fs/namei.c	2009-01-25 23:09:50.000000000 -0700
@@ -1948,7 +1948,7 @@ out:
 	return error;
 }
 
-asmlinkage long sys_mkdir(const char __user *pathname, int mode)
+SYSCALL_DEFINE2(mkdir, const char __user *, pathname, int, mode)
 {
 	return sys_mkdirat(AT_FDCWD, pathname, mode);
 }
@@ -2055,7 +2055,7 @@ exit:
 	return error;
 }
 
-asmlinkage long sys_rmdir(const char __user *pathname)
+SYSCALL_DEFINE1(rmdir, const char __user *, pathname)
 {
 	return do_rmdir(AT_FDCWD, pathname);
 }
diff -urpN linux-source-2.6.18.orig/fs/open.c linux-source-2.6.18/fs/open.c
--- linux-source-2.6.18.orig/fs/open.c	2009-01-25 23:06:21.000000000 -0700
+++ linux-source-2.6.18/fs/open.c	2009-01-25 23:09:50.000000000 -0700
@@ -557,7 +557,7 @@ SYSCALL_DEFINE2(access, const char __use
 	return sys_faccessat(AT_FDCWD, filename, mode);
 }
 
-asmlinkage long sys_chdir(const char __user * filename)
+SYSCALL_DEFINE1(chdir, const char __user *, filename)
 {
 	struct nameidata nd;
 	int error;
@@ -578,7 +578,7 @@ out:
 	return error;
 }
 
-asmlinkage long sys_fchdir(unsigned int fd)
+SYSCALL_DEFINE1(fchdir, unsigned int, fd)
 {
 	struct file *file;
 	struct dentry *dentry;
diff -urpN linux-source-2.6.18.orig/fs/quota.c linux-source-2.6.18/fs/quota.c
--- linux-source-2.6.18.orig/fs/quota.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/fs/quota.c	2009-01-25 23:09:50.000000000 -0700
@@ -343,7 +343,8 @@ static int do_quotactl(struct super_bloc
  * calls. Maybe we need to add the process quotas etc. in the future,
  * but we probably should use rlimits for that.
  */
-asmlinkage long sys_quotactl(unsigned int cmd, const char __user *special, qid_t id, void __user *addr)
+SYSCALL_DEFINE4(quotactl, unsigned int, cmd, const char __user *, special,
+		qid_t, id, void __user *, addr)
 {
 	uint cmds, type;
 	struct super_block *sb = NULL;
diff -urpN linux-source-2.6.18.orig/fs/read_write.c linux-source-2.6.18/fs/read_write.c
--- linux-source-2.6.18.orig/fs/read_write.c	2009-01-25 23:05:44.000000000 -0700
+++ linux-source-2.6.18/fs/read_write.c	2009-01-25 23:09:50.000000000 -0700
@@ -339,7 +339,7 @@ static inline void file_pos_write(struct
 	file->f_pos = pos;
 }
 
-asmlinkage long sys_read(unsigned int fd, char __user * buf, size_t count)
+SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)
 {
 	struct file *file;
 	ssize_t ret = -EBADF;
@@ -357,7 +357,8 @@ asmlinkage long sys_read(unsigned int fd
 }
 EXPORT_SYMBOL_GPL(sys_read);
 
-asmlinkage long sys_write(unsigned int fd, const char __user * buf, size_t count)
+SYSCALL_DEFINE3(write, unsigned int, fd, const char __user *, buf,
+		size_t, count)
 {
 	struct file *file;
 	ssize_t ret = -EBADF;
@@ -610,8 +611,8 @@ ssize_t vfs_writev(struct file *file, co
 
 EXPORT_SYMBOL(vfs_writev);
 
-asmlinkage long
-sys_readv(unsigned long fd, const struct iovec __user *vec, unsigned long vlen)
+SYSCALL_DEFINE3(readv, unsigned long, fd, const struct iovec __user *, vec,
+		unsigned long, vlen)
 {
 	struct file *file;
 	ssize_t ret = -EBADF;
@@ -631,8 +632,8 @@ sys_readv(unsigned long fd, const struct
 	return ret;
 }
 
-asmlinkage long
-sys_writev(unsigned long fd, const struct iovec __user *vec, unsigned long vlen)
+SYSCALL_DEFINE3(writev, unsigned long, fd, const struct iovec __user *, vec,
+		unsigned long, vlen)
 {
 	struct file *file;
 	ssize_t ret = -EBADF;
