From d4e82042c4cfa87a7d51710b71f568fe80132551 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:14:34 +0100
Subject: [PATCH 42/44] [CVE-2009-0029] System call wrappers part 32

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit d4e82042c4cfa87a7d51710b71f568fe80132551 upstream.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.24 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.24.orig/fs/eventfd.c linux-source-2.6.24/fs/eventfd.c
--- linux-source-2.6.24.orig/fs/eventfd.c	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/fs/eventfd.c	2009-01-21 01:25:43.000000000 -0700
@@ -197,7 +197,7 @@ struct file *eventfd_fget(int fd)
 	return file;
 }
 
-asmlinkage long sys_eventfd(unsigned int count)
+SYSCALL_DEFINE1(eventfd, unsigned int, count)
 {
 	int error, fd;
 	struct eventfd_ctx *ctx;
diff -urpN linux-source-2.6.24.orig/fs/readdir.c linux-source-2.6.24/fs/readdir.c
--- linux-source-2.6.24.orig/fs/readdir.c	2009-01-21 01:14:06.000000000 -0700
+++ linux-source-2.6.24/fs/readdir.c	2009-01-21 01:25:43.000000000 -0700
@@ -97,7 +97,8 @@ efault:
 	return -EFAULT;
 }
 
-asmlinkage long sys_old_readdir(unsigned int fd, struct old_linux_dirent __user * dirent, unsigned int count)
+SYSCALL_DEFINE3(old_readdir, unsigned int, fd,
+		struct old_linux_dirent __user *, dirent, unsigned int, count)
 {
 	int error;
 	struct file * file;
diff -urpN linux-source-2.6.24.orig/fs/select.c linux-source-2.6.24/fs/select.c
--- linux-source-2.6.24.orig/fs/select.c	2009-01-21 01:15:04.000000000 -0700
+++ linux-source-2.6.24/fs/select.c	2009-01-21 01:26:21.000000000 -0700
@@ -512,8 +512,9 @@ sticky:
  * which has a pointer to the sigset_t itself followed by a size_t containing
  * the sigset size.
  */
-asmlinkage long sys_pselect6(int n, fd_set __user *inp, fd_set __user *outp,
-	fd_set __user *exp, struct timespec __user *tsp, void __user *sig)
+SYSCALL_DEFINE6(pselect6, int, n, fd_set __user *, inp, fd_set __user *, outp,
+		fd_set __user *, exp, struct timespec __user *, tsp,
+		void __user *, sig)
 {
 	size_t sigsetsize = 0;
 	sigset_t __user *up = NULL;
@@ -760,9 +761,9 @@ SYSCALL_DEFINE3(poll, struct pollfd __us
 }
 
 #ifdef TIF_RESTORE_SIGMASK
-asmlinkage long sys_ppoll(struct pollfd __user *ufds, unsigned int nfds,
-	struct timespec __user *tsp, const sigset_t __user *sigmask,
-	size_t sigsetsize)
+SYSCALL_DEFINE5(ppoll, struct pollfd __user *, ufds, unsigned int, nfds,
+		struct timespec __user *, tsp, const sigset_t __user *, sigmask,
+		size_t, sigsetsize)
 {
 	sigset_t ksigmask, sigsaved;
 	struct timespec ts;
diff -urpN linux-source-2.6.24.orig/include/linux/syscalls.h linux-source-2.6.24/include/linux/syscalls.h
--- linux-source-2.6.24.orig/include/linux/syscalls.h	2009-01-21 00:45:15.000000000 -0700
+++ linux-source-2.6.24/include/linux/syscalls.h	2009-01-21 01:25:43.000000000 -0700
@@ -668,6 +668,13 @@ asmlinkage long sys_timerfd(int ufd, int
 asmlinkage long sys_eventfd(unsigned int count);
 asmlinkage long sys_fallocate(int fd, int mode, loff_t offset, loff_t len);
 asmlinkage long sys_old_readdir(unsigned int, struct old_linux_dirent __user *, unsigned int);
+asmlinkage long sys_pselect6(int, fd_set __user *, fd_set __user *,
+			     fd_set __user *, struct timespec __user *,
+			     void __user *);
+asmlinkage long sys_ppoll(struct pollfd __user *, unsigned int,
+			  struct timespec __user *, const sigset_t __user *,
+			  size_t);
+asmlinkage long sys_pipe2(int __user *, int);
 
 int kernel_execve(const char *filename, char *const argv[], char *const envp[]);
 
diff -urpN linux-source-2.6.24.orig/kernel/signal.c linux-source-2.6.24/kernel/signal.c
--- linux-source-2.6.24.orig/kernel/signal.c	2009-01-21 01:02:55.000000000 -0700
+++ linux-source-2.6.24/kernel/signal.c	2009-01-21 01:25:43.000000000 -0700
@@ -2475,11 +2475,10 @@ out:
 #endif /* __ARCH_WANT_SYS_SIGPROCMASK */
 
 #ifdef __ARCH_WANT_SYS_RT_SIGACTION
-asmlinkage long
-sys_rt_sigaction(int sig,
-		 const struct sigaction __user *act,
-		 struct sigaction __user *oact,
-		 size_t sigsetsize)
+SYSCALL_DEFINE4(rt_sigaction, int, sig,
+		const struct sigaction __user *, act,
+		struct sigaction __user *, oact,
+		size_t, sigsetsize)
 {
 	struct k_sigaction new_sa, old_sa;
 	int ret = -EINVAL;
@@ -2562,7 +2561,7 @@ SYSCALL_DEFINE0(pause)
 #endif
 
 #ifdef __ARCH_WANT_SYS_RT_SIGSUSPEND
-asmlinkage long sys_rt_sigsuspend(sigset_t __user *unewset, size_t sigsetsize)
+SYSCALL_DEFINE2(rt_sigsuspend, sigset_t __user *, unewset, size_t, sigsetsize)
 {
 	sigset_t newset;
 
diff -urpN linux-source-2.6.24.orig/fs/timerfd.c linux-source-2.6.24/fs/timerfd.c
--- linux-source-2.6.24.orig/fs/timerfd.c	2009-01-21 01:25:43.000000000 -0700
+++ linux-source-2.6.24/fs/timerfd.c	2009-01-21 01:30:08.000000000 -0700
@@ -150,8 +150,8 @@ static const struct file_operations time
 	.read		= timerfd_read,
 };
 
-asmlinkage long sys_timerfd(int ufd, int clockid, int flags,
-			    const struct itimerspec __user *utmr)
+SYSCALL_DEFINE4(timerfd, int, ufd, int, clockid, int, flags,
+		const struct itimerspec __user *, utmr)
 {
 	int error;
 	struct timerfd_ctx *ctx;
