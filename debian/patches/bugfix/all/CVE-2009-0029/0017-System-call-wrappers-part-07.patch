From 754fe8d297bfae7b77f7ce866e2fb0c5fb186506 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:14:09 +0100
Subject: [PATCH 17/44] [CVE-2009-0029] System call wrappers part 07

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit 754fe8d297bfae7b77f7ce866e2fb0c5fb186506 upstream.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.18 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.18.orig/kernel/exit.c linux-source-2.6.18/kernel/exit.c
--- linux-source-2.6.18.orig/kernel/exit.c	2009-01-25 19:39:05.000000000 -0700
+++ linux-source-2.6.18/kernel/exit.c	2009-01-25 20:39:03.000000000 -0700
@@ -977,7 +977,7 @@ NORET_TYPE void complete_and_exit(struct
 
 EXPORT_SYMBOL(complete_and_exit);
 
-asmlinkage long sys_exit(int error_code)
+SYSCALL_DEFINE1(exit, int, error_code)
 {
 	do_exit((error_code&0xff)<<8);
 }
@@ -1016,7 +1016,7 @@ do_group_exit(int exit_code)
  * wait4()-ing process will get the correct exit code - even if this
  * thread is not the thread group leader.
  */
-asmlinkage long sys_exit_group(int error_code)
+SYSCALL_DEFINE1(exit_group, int, error_code)
 {
 	do_group_exit((error_code & 0xff) << 8);
 	/* NOTREACHED */
@@ -1625,8 +1625,8 @@ asmlinkage long sys_waitid(int which, pi
 	return ret;
 }
 
-asmlinkage long sys_wait4(pid_t pid, int __user *stat_addr,
-			  int options, struct rusage __user *ru)
+SYSCALL_DEFINE4(wait4, pid_t, pid, int __user *, stat_addr,
+		int, options, struct rusage __user *, ru)
 {
 	long ret;
 
diff -urpN linux-source-2.6.18.orig/kernel/kexec.c linux-source-2.6.18/kernel/kexec.c
--- linux-source-2.6.18.orig/kernel/kexec.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/kernel/kexec.c	2009-01-25 20:39:03.000000000 -0700
@@ -911,9 +911,8 @@ struct kimage *kexec_crash_image;
  */
 static int kexec_lock;
 
-asmlinkage long sys_kexec_load(unsigned long entry, unsigned long nr_segments,
-				struct kexec_segment __user *segments,
-				unsigned long flags)
+SYSCALL_DEFINE4(kexec_load, unsigned long, entry, unsigned long, nr_segments,
+		struct kexec_segment __user *, segments, unsigned long, flags)
 {
 	struct kimage **dest_image, *image;
 	int locked;
diff -urpN linux-source-2.6.18.orig/kernel/sched.c linux-source-2.6.18/kernel/sched.c
--- linux-source-2.6.18.orig/kernel/sched.c	2009-01-25 20:38:31.000000000 -0700
+++ linux-source-2.6.18/kernel/sched.c	2009-01-25 20:39:03.000000000 -0700
@@ -4673,8 +4673,8 @@ SYSCALL_DEFINE1(sched_get_priority_min, 
  * this syscall writes the default timeslice value of a given process
  * into the user-space timespec buffer. A value of '0' means infinity.
  */
-asmlinkage
-long sys_sched_rr_get_interval(pid_t pid, struct timespec __user *interval)
+SYSCALL_DEFINE4(sched_rr_get_interval, pid_t, pid,
+		struct timespec __user *, interval)
 {
 	struct task_struct *p;
 	int retval = -EINVAL;
diff -urpN linux-source-2.6.18.orig/kernel/signal.c linux-source-2.6.18/kernel/signal.c
--- linux-source-2.6.18.orig/kernel/signal.c	2009-01-25 20:36:32.000000000 -0700
+++ linux-source-2.6.18/kernel/signal.c	2009-01-25 20:39:03.000000000 -0700
@@ -1919,7 +1919,7 @@ EXPORT_SYMBOL(unblock_all_signals);
  * System call entry points.
  */
 
-asmlinkage long sys_restart_syscall(void)
+SYSCALL_DEFINE0(restart_syscall)
 {
 	struct restart_block *restart = &current_thread_info()->restart_block;
 	return restart->fn(restart);
diff -urpN linux-source-2.6.18.orig/kernel/sys.c linux-source-2.6.18/kernel/sys.c
--- linux-source-2.6.18.orig/kernel/sys.c	2009-01-25 20:36:54.000000000 -0700
+++ linux-source-2.6.18/kernel/sys.c	2009-01-25 20:39:03.000000000 -0700
@@ -459,7 +459,7 @@ out:
 	return error;
 }
 
-asmlinkage long sys_setpriority(int which, int who, int niceval)
+SYSCALL_DEFINE3(setpriority, int, which, int, who, int, niceval)
 {
 	struct task_struct *g, *p;
 	struct user_struct *user;
@@ -519,7 +519,7 @@ out:
  * has been offset by 20 (ie it returns 40..1 instead of -20..19)
  * to stay compatible.
  */
-asmlinkage long sys_getpriority(int which, int who)
+SYSCALL_DEFINE2(getpriority, int, which, int, who)
 {
 	struct task_struct *g, *p;
 	struct user_struct *user;
@@ -678,7 +678,8 @@ EXPORT_SYMBOL_GPL(kernel_power_off);
  *
  * reboot doesn't sync: do that yourself before calling this.
  */
-asmlinkage long sys_reboot(int magic1, int magic2, unsigned int cmd, void __user * arg)
+SYSCALL_DEFINE4(reboot, int, magic1, int, magic2, unsigned int, cmd,
+		void __user *, arg)
 {
 	char buffer[256];
 
diff -urpN linux-source-2.6.18.orig/net/socket.c linux-source-2.6.18/net/socket.c
--- linux-source-2.6.18.orig/net/socket.c	2006-09-19 21:42:06.000000000 -0600
+++ linux-source-2.6.18/net/socket.c	2009-01-25 20:39:03.000000000 -0700
@@ -1729,7 +1729,7 @@ out_put:
  *	Shutdown a socket.
  */
 
-asmlinkage long sys_shutdown(int fd, int how)
+SYSCALL_DEFINE2(shutdown, int, fd, int, how)
 {
 	int err, fput_needed;
 	struct socket *sock;
