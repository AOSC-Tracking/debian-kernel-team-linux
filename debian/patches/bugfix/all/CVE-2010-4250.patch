From: Eric Paris <eparis@redhat.com>
Date: Tue, 23 Nov 2010 18:18:37 -0500
Subject: [PATCH] inotify: stop kernel memory leak on file creation failure

commit a2ae4cc9a16e211c8a128ba10d22a85431f093ab upstream.

If inotify_init is unable to allocate a new file for the new inotify
group we leak the new group.  This patch drops the reference on the
group on file allocation failure.

Reported-by: Vegard Nossum <vegard.nossum@gmail.com>
cc: stable@kernel.org
Signed-off-by: Eric Paris <eparis@redhat.com>

[Adapted to 2.6.32]

diff -aur linux-2.6.32.28.orig//fs/notify/inotify/inotify_user.c linux-2.6.32.28/fs/notify/inotify/inotify_user.c
--- linux-2.6.32.28.orig//fs/notify/inotify/inotify_user.c	2011-01-08 00:08:43.000000000 +0100
+++ linux-2.6.32.28/fs/notify/inotify/inotify_user.c	2011-01-15 11:37:09.000000000 +0100
@@ -699,6 +699,7 @@
 	filp->f_flags = O_RDONLY | (flags & O_NONBLOCK);
 	filp->private_data = group;
 
+        fsnotify_put_group(group);
 	atomic_inc(&user->inotify_devs);
 
 	fd_install(fd, filp);
