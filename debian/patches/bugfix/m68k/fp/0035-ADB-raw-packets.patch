From 9bd0232b2cbe128a771b1937e7f8accbadae3c21 Mon Sep 17 00:00:00 2001
From: Linux/m68k legacy <xxx@linux-m68k.org>
Date: Tue, 18 Nov 2008 21:22:20 +0100
Subject: [PATCH] ADB raw packets

ADB: add support for raw packets
---
 drivers/macintosh/adb.c |    7 ++++---
 include/linux/adb.h     |    1 +
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/macintosh/adb.c b/drivers/macintosh/adb.c
index 23741ce..57790a0 100644
--- a/drivers/macintosh/adb.c
+++ b/drivers/macintosh/adb.c
@@ -412,13 +412,14 @@ adb_request(struct adb_request *req, void (*done)(struct adb_request *),
 	if (nbytes < 1)
 		return -EINVAL;
 
-	req->nbytes = nbytes+1;
+	i = (flags & ADBREQ_RAW) ? 0 : 1;
+	req->nbytes = nbytes+i;
 	req->done = done;
 	req->reply_expected = flags & ADBREQ_REPLY;
 	req->data[0] = ADB_PACKET;
 	va_start(list, nbytes);
-	for (i = 0; i < nbytes; ++i)
-		req->data[i+1] = va_arg(list, int);
+	while (i < req->nbytes)
+		req->data[i++] = va_arg(list, int);
 	va_end(list);
 
 	if (flags & ADBREQ_NOSEND)
diff --git a/include/linux/adb.h b/include/linux/adb.h
index 63bca50..1cf0e7d 100644
--- a/include/linux/adb.h
+++ b/include/linux/adb.h
@@ -76,6 +76,7 @@ struct adb_driver {
 #define ADBREQ_REPLY	1	/* expect reply */
 #define ADBREQ_SYNC	2	/* poll until done */
 #define ADBREQ_NOSEND	4	/* build the request, but don't send it */
+#define ADBREQ_RAW	8	/* send raw packet (don't prepend ADB_PACKET) */
 
 /* Messages sent thru the client_list notifier. You should NOT stop
    the operation, at least not with this version */
-- 
1.5.6.5

