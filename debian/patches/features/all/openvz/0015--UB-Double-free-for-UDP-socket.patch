From 849af42466bed078e6953a4eeeff28c81f64a983 Mon Sep 17 00:00:00 2001
From: Denis Lunev <den@openvz.org>
Date: Tue, 9 Sep 2008 17:55:51 +0400
Subject: [PATCH] [UB]: Double free for UDP socket

The socket resided in UB space waiting queue could be released. In this
case ub_snd_wakeup running on the another CPU could hold/release that
socket effectively hitting 0 refcounter second time.

Signed-off-by: Denis V. Lunev <den@openvz.org>
Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
---
 net/socket.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/net/socket.c b/net/socket.c
index 58a9495..09d8fc5 100644
--- a/net/socket.c
+++ b/net/socket.c
@@ -518,6 +518,9 @@ const struct file_operations bad_sock_fops = {
 
 void sock_release(struct socket *sock)
 {
+	if (sock->sk)
+		ub_sock_sndqueuedel(sock->sk);
+
 	if (sock->ops) {
 		struct module *owner = sock->ops->owner;
 
-- 
1.6.0.6

