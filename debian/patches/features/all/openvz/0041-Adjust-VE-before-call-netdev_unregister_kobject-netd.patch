From 35f41f111afc1a9f024153ac43d8d829a894fb2b Mon Sep 17 00:00:00 2001
From: Vitaliy Gusev <vgusev@openvz.org>
Date: Tue, 14 Oct 2008 19:20:33 +0400
Subject: [PATCH] Adjust VE before call netdev_unregister_kobject/netdev_register_kobject

These function use visible_net_class.

http://bugzilla.openvz.org/show_bug.cgi?id=1044

Signed-off-by: Vitaliy Gusev <vgusev@openvz.org>
Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
---
 net/core/dev.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/net/core/dev.c b/net/core/dev.c
index ce7e730..246deda 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -4306,8 +4306,11 @@ int __dev_change_net_namespace(struct net_device *dev, struct net *net, const ch
 	}
 
 	/* Fixup kobjects */
+	set_exec_env(src_ve);
 	netdev_unregister_kobject(dev);
+	set_exec_env(dst_ve);
 	err = netdev_register_kobject(dev);
+	set_exec_env(cur_ve);
 	WARN_ON(err);
 
 	/* Add the device back in the hashes */
-- 
1.6.0.6

