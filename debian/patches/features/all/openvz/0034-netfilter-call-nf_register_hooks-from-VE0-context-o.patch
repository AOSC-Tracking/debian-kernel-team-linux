From 490910232ebe61f65e5e5c03b7286f11291b6092 Mon Sep 17 00:00:00 2001
From: Vitaliy Gusev <vgusev@openvz.org>
Date: Wed, 1 Oct 2008 12:12:36 +0400
Subject: [PATCH] netfilter: call nf_register_hooks from VE0 context only

Signed-off-by: Vitaliy Gusev <vgusev@openvz.org>
Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
---
 net/ipv4/netfilter/nf_nat_standalone.c |   14 +++++++++-----
 1 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/net/ipv4/netfilter/nf_nat_standalone.c b/net/ipv4/netfilter/nf_nat_standalone.c
index 9aec464..72f45db 100644
--- a/net/ipv4/netfilter/nf_nat_standalone.c
+++ b/net/ipv4/netfilter/nf_nat_standalone.c
@@ -295,10 +295,13 @@ int init_nftable_nat(void)
 		printk("nf_nat_init: can't setup rules.\n");
 		goto out_modput;
 	}
-	ret = nf_register_hooks(nf_nat_ops, ARRAY_SIZE(nf_nat_ops));
-	if (ret < 0) {
-		printk("nf_nat_init: can't register hooks.\n");
-		goto cleanup_rule_init;
+
+	if (ve_is_super(get_exec_env())) {
+		ret = nf_register_hooks(nf_nat_ops, ARRAY_SIZE(nf_nat_ops));
+		if (ret < 0) {
+			printk("nf_nat_init: can't register hooks.\n");
+			goto cleanup_rule_init;
+		}
 	}
 	return 0;
 
@@ -312,7 +315,8 @@ out_modput:
 
 void fini_nftable_nat(void)
 {
-	nf_unregister_hooks(nf_nat_ops, ARRAY_SIZE(nf_nat_ops));
+	if (ve_is_super(get_exec_env()))
+		nf_unregister_hooks(nf_nat_ops, ARRAY_SIZE(nf_nat_ops));
 	nf_nat_rule_cleanup();
 	if (!ve_is_super(get_exec_env()))
 		module_put(THIS_MODULE);
-- 
1.6.0.6

