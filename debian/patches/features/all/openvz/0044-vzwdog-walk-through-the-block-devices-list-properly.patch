From 6b9fe0296b1aa5b2e70e9ba9790e4bd9af5908c6 Mon Sep 17 00:00:00 2001
From: Pavel Emelyanov <xemul@openvz.org>
Date: Wed, 5 Nov 2008 11:53:48 +0300
Subject: [PATCH] vzwdog: walk through the block devices list properly

Copied check from the show_partitions...

http://bugzilla.openvz.org/show_bug.cgi?id=1064

Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
---
 block/genhd.c         |    5 +++--
 include/linux/genhd.h |    1 +
 kernel/ve/vzwdog.c    |    6 +++++-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/block/genhd.c b/block/genhd.c
index 901cf04..93ffcfb 100644
--- a/block/genhd.c
+++ b/block/genhd.c
@@ -24,7 +24,8 @@ static DEFINE_MUTEX(block_class_lock);
 struct kobject *block_depr;
 #endif
 
-static struct device_type disk_type;
+struct device_type disk_type;
+EXPORT_SYMBOL(disk_type);
 
 /*
  * Can be deleted altogether. Later.
@@ -515,7 +516,7 @@ struct class block_class = {
 };
 EXPORT_SYMBOL(block_class);
 
-static struct device_type disk_type = {
+struct device_type disk_type = {
 	.name		= "disk",
 	.groups		= disk_attr_groups,
 	.release	= disk_release,
diff --git a/include/linux/genhd.h b/include/linux/genhd.h
index ae7aec3..8f28767 100644
--- a/include/linux/genhd.h
+++ b/include/linux/genhd.h
@@ -21,6 +21,7 @@
 extern struct device_type part_type;
 extern struct kobject *block_depr;
 extern struct class block_class;
+extern struct device_type disk_type;
 
 extern const struct seq_operations partitions_op;
 extern const struct seq_operations diskstats_op;
diff --git a/kernel/ve/vzwdog.c b/kernel/ve/vzwdog.c
index 7117365..4510f5d 100644
--- a/kernel/ve/vzwdog.c
+++ b/kernel/ve/vzwdog.c
@@ -184,8 +184,12 @@ static void show_diskio(void)
 
 	list_for_each_entry(dev, &block_class.devices, node) {
 		char *name;
-		struct gendisk *gd = dev_to_disk(dev);
+		struct gendisk *gd;
+		
+		if (dev->type != &disk_type)
+			continue;
 
+		gd = dev_to_disk(dev);
 		name = disk_name(gd, 0, buf);
 		if ((strlen(name) > 4) && (strncmp(name, "loop", 4) == 0) &&
 		    isdigit(name[4]))
-- 
1.6.0.6

